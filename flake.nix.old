{
  description = "My Awesome Desktop Shell";

  inputs = {
    nixpkgs.url = "github:nixos/nixpkgs/nixos-unstable";

    ags = {
      url = "github:aylur/ags";
      inputs.nixpkgs.follows = "nixpkgs";
    };
  };

  outputs = { self, nixpkgs, ags, ... }:
    let
      systems = [ "x86_64-linux" "aarch64-linux" ];
      forAllSystems = nixpkgs.lib.genAttrs systems;
    in
    {
      packages = forAllSystems (system:
        let
          pkgs = nixpkgs.legacyPackages.${system};

          # ---- Runtime deps (GI typelibs live here) ----
          runtimeDeps = [
            pkgs.gjs
            ags.packages.${system}.astal4
            ags.packages.${system}.apps
            ags.packages.${system}.auth
            ags.packages.${system}.battery
            ags.packages.${system}.bluetooth
            ags.packages.${system}.cava
            ags.packages.${system}.greet
            ags.packages.${system}.hyprland
            ags.packages.${system}.io
            ags.packages.${system}.mpris
            ags.packages.${system}.network
            ags.packages.${system}.notifd
            ags.packages.${system}.powerprofiles
            ags.packages.${system}.tray
            ags.packages.${system}.wireplumber
            pkgs.libadwaita
            pkgs.accountsservice
            pkgs.libsoup_3
          ];
        in
        {
          default = pkgs.stdenv.mkDerivation {
            pname = "my-shell";
            version = "0.1.0";
            src = ./.;

            # ---- Build-time hooks ----
            nativeBuildInputs = [
              pkgs.wrapGAppsHook4
              pkgs.gobject-introspection
              ags.packages.${system}.default
            ];

            # ---- Runtime inputs (picked up by wrapGAppsHook4) ----
            buildInputs = runtimeDeps;

            installPhase = ''
              runHook preInstall

              mkdir -p $out/bin
              mkdir -p $out/share/my-shell

              # Copy source (JS, CSS, types, assets)
              cp -r . $out/share/my-shell

              # Bundle main shell
              ags bundle \
                $out/share/my-shell/main.app.ts \
                $out/bin/my-shell \
                -r $out/share/my-shell \
                -g 4 \
                -d "SRC='$out/share/my-shell'"

              # Bundle greeter
              ags bundle \
                $out/share/my-shell/greeter.app.ts \
                $out/bin/my-greeter \
                -r $out/share/my-shell \
                -g 4 \
                -d "SRC='$out/share/my-shell'"

              runHook postInstall
            '';
          };
        }
      );

      # ---- Dev shell (matches runtime exactly) ----
      devShells = forAllSystems (system:
        let
          pkgs = nixpkgs.legacyPackages.${system};
        in
        {
          default = pkgs.mkShell {
            nativeBuildInputs = [
              ags.packages.${system}.default
            ];

            buildInputs = [
              pkgs.gjs
              ags.packages.${system}.astal4
              pkgs.libadwaita
              pkgs.accountsservice
              pkgs.libsoup_3
              pkgs.accountsservice.dev
            ];
          };
        }
      );
    };
}
